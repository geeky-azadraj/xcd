groups:
  - name: nestjs-application-alerts
    interval: 30s

    rules:
      # === High Error Rate Alert ===
      - alert: HighErrorRate
        expr: nestjs:api_error_rate_percent > 5
        for: 5m
        labels:
          severity: critical
          team: backend
        annotations:
          summary: 'High Error Rate ({{ $value }}%)'
          description: 'More than 5% of API requests are failing for over 5 minutes.'

      # === High P99 Latency Alert ===
      - alert: HighP99Latency
        expr: nestjs:api_latency_p99 > 2
        for: 5m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: 'High API Latency (P99 > 2s)'
          description: 'API P99 latency is above 2 seconds for the last 5 minutes.'

      # === Very High Concurrent Requests Alert ===
      - alert: HighConcurrentRequests
        expr: concurrent_http_requests > 500
        for: 2m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: 'High Concurrent API Requests ({{ $value }})'
          description: 'More than 500 concurrent API requests detected.'

      # === Node Exporter Host Disk Full Alert ===
      - alert: HostDiskAlmostFull
        expr: (node_filesystem_avail_bytes{fstype!~"tmpfs|overlay"} / node_filesystem_size_bytes{fstype!~"tmpfs|overlay"}) < 0.15
        for: 10m
        labels:
          severity: critical
          team: devops
        annotations:
          summary: 'Disk Almost Full'
          description: 'Less than 15% disk space remaining on server.'
